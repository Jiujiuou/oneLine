<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>算法可视化测试</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .controls { margin-bottom: 20px; }
        .grid-container { 
            display: inline-grid; 
            gap: 5px; 
            background: #f0f0f0; 
            padding: 10px; 
            border-radius: 8px;
        }
        .cell {
            width: 50px;
            height: 50px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 18px;
        }
        .cell.obstacle { background: #333; color: #333; }
        .cell.hint { background: #e6f7ff; color: #1890ff; border-color: #91d5ff; }
        .cell.hidden { color: #ccc; font-size: 12px; }
        .info { margin-top: 10px; color: #666; }
    </style>
</head>
<body>
    <h1>核心算法可视化验证</h1>
    <div class="controls">
        <label>行数: <input type="number" id="rows" value="5" min="3" max="8"></label>
        <label>列数: <input type="number" id="cols" value="5" min="3" max="8"></label>
        <label>隐藏率: <input type="number" id="rate" value="0.5" step="0.1" min="0" max="1"></label>
        <button onclick="runTest()">生成并渲染</button>
    </div>
    <div id="output"></div>

    <script type="module">
        import { generateHamiltonianPath } from './src/utils/hamiltonian.js';
        import { generatePuzzle } from './src/utils/puzzleGenerator.js';

        window.runTest = () => {
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            const rate = parseFloat(document.getElementById('rate').value);
            
            const output = document.getElementById('output');
            output.innerHTML = '计算中...';

            // 1. 模拟随机生成几个障碍物 (在 5x5 时尝试生成 2 个)
            const obstacles = [];
            /* 暂时注释掉障碍物生成，专注于验证基础算法
            if (rows >= 5 && cols >= 5) {
                // 简单硬编码几个障碍物测试一下避障能力
                // 避免把起点(0,0) 或 终点围死，这里随机生成
                for(let i=0; i<2; i++) {
                    obstacles.push({
                        r: Math.floor(Math.random() * (rows - 2)) + 1, // 避开边缘
                        c: Math.floor(Math.random() * (cols - 2)) + 1
                    });
                }
            }
            */

            console.time('Algo');
            const path = generateHamiltonianPath(rows, cols, obstacles);
            console.timeEnd('Algo');

            if (!path) {
                output.innerHTML = `<div style="color:red">无解 (生成失败，请重试)</div>`;
                return;
            }

            const { hints } = generatePuzzle(path, rate);

            renderGrid(rows, cols, path, hints, obstacles);
        };

        function renderGrid(rows, cols, path, hints, obstacles) {
            const container = document.createElement('div');
            container.className = 'grid-container';
            container.style.gridTemplateColumns = `repeat(${cols}, 50px)`;
            container.style.gridTemplateRows = `repeat(${rows}, 50px)`;

            // 构建一个便于查询的 map: "r,c" -> index
            const pathMap = {};
            path.forEach(p => pathMap[`${p.r},${p.c}`] = p.index);

            // 构建障碍物 map
            const obsMap = {};
            obstacles.forEach(o => obsMap[`${o.r},${o.c}`] = true);

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const key = `${r},${c}`;
                    const div = document.createElement('div');
                    div.className = 'cell';

                    if (obsMap[key]) {
                        div.className += ' obstacle';
                    } else {
                        const val = pathMap[key];
                        if (hints[key]) {
                            div.className += ' hint';
                            div.innerText = hints[key];
                        } else {
                            div.className += ' hidden';
                            div.innerText = val; // 显示出来方便调试，实际上是隐藏的
                        }
                    }
                    container.appendChild(div);
                }
            }

            const info = document.createElement('div');
            info.className = 'info';
            info.innerHTML = `
                障碍物数量: ${obstacles.length}<br>
                路径长度: ${path.length}<br>
                提示数量: ${Object.keys(hints).length}
            `;

            const output = document.getElementById('output');
            output.innerHTML = '';
            output.appendChild(container);
            output.appendChild(info);
        }
    </script>
</body>
</html>

